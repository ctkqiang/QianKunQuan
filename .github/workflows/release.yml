name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é¡¹ç›®ä¿¡æ¯
  PROJECT_NAME: "ä¹¾å¤åœˆ"  # ä¸­æ–‡é¡¹ç›®å
  PROJECT_CODE: "QianKunQuan"  # é¡¹ç›®ä»£ç å
  VERSION: ${{ github.ref_name }}
  
  # Go é…ç½®
  GO_VERSION: '1.21'
  GOARCH: 'amd64'
  
  # è¾“å‡ºç›®å½•
  OUTPUT_DIR: dist

jobs:
  build-matrix:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            binary_ext: ""
            target: linux
          - os: ubuntu-latest
            arch: arm64
            binary_ext: ""
            target: linux-arm64
          - os: macos-latest
            arch: amd64
            binary_ext: ""
            target: darwin
          - os: macos-latest
            arch: arm64
            binary_ext: ""
            target: darwin-arm64
          - os: windows-latest
            arch: amd64
            binary_ext: ".exe"
            target: windows
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Print build information
      run: |
        echo "ğŸ—ï¸  Building ${{ env.PROJECT_NAME }} (${{ env.PROJECT_CODE }})"
        echo "ğŸ“¦ Version: ${{ env.VERSION }}"
        echo "ğŸ’» OS: ${{ matrix.target }}"
        echo "âš™ï¸  Architecture: ${{ matrix.arch }}"
        echo "ğŸ“ Output directory: ${{ env.OUTPUT_DIR }}"
    
    - name: Install dependencies
      run: |
        go mod download
        go mod verify
    
    - name: Create output directory
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }}
    
    - name: Build binary
      run: |
        # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
        BINARY_NAME="${{ env.PROJECT_CODE }}-${{ env.VERSION }}-${{ matrix.target }}-${{ matrix.arch }}${{ matrix.binary_ext }}"
        
        echo "ğŸ”¨ Building: $BINARY_NAME"
        
        # è®¾ç½®æ„å»ºå˜é‡
        GOOS=${{ matrix.target == 'darwin' && 'darwin' || matrix.target == 'windows' && 'windows' || 'linux' }}
        GOARCH=${{ matrix.arch }}
        
        # æ‰§è¡Œæ„å»º
        CGO_ENABLED=0 go build \
          -trimpath \
          -ldflags="\
            -X 'main.Version=${{ env.VERSION }}' \
            -X 'main.BuildTime=$(date -u "+%Y-%m-%d %H:%M:%S")' \
            -X 'main.CommitHash=$(git rev-parse --short HEAD)' \
            -s -w" \
          -o "${{ env.OUTPUT_DIR }}/$BINARY_NAME" \
          ./cmd
        
        echo "âœ… Build completed: $BINARY_NAME"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -lh "${{ env.OUTPUT_DIR }}/$BINARY_NAME"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target }}-${{ matrix.arch }}
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-matrix
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: List downloaded files
      run: |
        echo "ğŸ“‚ Downloaded artifacts:"
        find artifacts -type f -name "*.exe" -o -name "*" | sort
    
    - name: Create release package
      run: |
        # åˆ›å»ºå‘è¡Œç‰ˆç›®å½•
        mkdir -p release
        
        # å¤åˆ¶æ‰€æœ‰æ„å»ºæ–‡ä»¶åˆ°releaseç›®å½•
        find artifacts -type f -exec cp {} release/ \;
        
        # åˆ›å»ºæ ¡éªŒæ–‡ä»¶
        cd release
        echo "# ${{ env.PROJECT_NAME }} ${{ env.VERSION }}" > CHECKSUM.md
        echo "## æ„å»ºä¿¡æ¯" >> CHECKSUM.md
        echo "- ç‰ˆæœ¬: ${{ env.VERSION }}" >> CHECKSUM.md
        echo "- æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CHECKSUM.md
        echo "- Gitæäº¤: $(git rev-parse --short HEAD)" >> CHECKSUM.md
        echo "" >> CHECKSUM.md
        echo "## æ–‡ä»¶æ ¡éªŒå’Œ (SHA256)" >> CHECKSUM.md
        echo "" >> CHECKSUM.md
        
        # ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆæ ¡éªŒå’Œ
        for file in *; do
          if [ -f "$file" ]; then
            sha256sum "$file" >> SHA256SUMS.txt
            echo "- \`$file\`" >> CHECKSUM.md
            echo "  \`$(sha256sum "$file" | cut -d' ' -f1)\`" >> CHECKSUM.md
          fi
        done
        
        # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“¦ Release files:"
        ls -lh
        
        echo ""
        echo "ğŸ” SHA256 checksums:"
        cat SHA256SUMS.txt
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "ğŸ‰ ${{ env.PROJECT_NAME }} ${{ env.VERSION }}"
        body: |
          # ğŸ›¡ï¸ ${{ env.PROJECT_NAME }} - ç«¯å£æ‰«æä¸CVEæ£€æµ‹å·¥å…·
          
          ## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬å·**: ${{ env.VERSION }}
          - **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Gitæäº¤**: $(git rev-parse --short HEAD)
          
          ## ğŸ“¥ ä¸‹è½½æ–‡ä»¶
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š
          
          ### ğŸ§ Linux
          - **64ä½**: [${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-amd64](./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-amd64)
          - **ARM64**: [${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-arm64](./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-arm64)
          
          ### ğŸ macOS
          - **IntelèŠ¯ç‰‡**: [${{ env.PROJECT_CODE }}-${{ env.VERSION }}-darwin-amd64](./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-darwin-amd64)
          - **AppleèŠ¯ç‰‡**: [${{ env.PROJECT_CODE }}-${{ env.VERSION }}-darwin-arm64](./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-darwin-arm64)
          
          ### ğŸªŸ Windows
          - **64ä½**: [${{ env.PROJECT_CODE }}-${{ env.VERSION }}-windows-amd64.exe](./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-windows-amd64.exe)
          
          ## ğŸ” æ–‡ä»¶æ ¡éªŒ
          æ‰€æœ‰æ–‡ä»¶çš„SHA256æ ¡éªŒå’Œå¯åœ¨ [SHA256SUMS.txt](./SHA256SUMS.txt) ä¸­æŸ¥çœ‹ã€‚
          
          ## ğŸš€ ä½¿ç”¨è¯´æ˜
          ```bash
          # ä¸‹è½½å¯¹åº”ç‰ˆæœ¬
          chmod +x ${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-amd64
          
          # åŸºæœ¬ä½¿ç”¨
          ./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-amd64 -target example.com
          
          # æŸ¥çœ‹å¸®åŠ©
          ./${{ env.PROJECT_CODE }}-${{ env.VERSION }}-linux-amd64 -help
          ```
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - âœ… ç«¯å£æ‰«æï¼ˆç±»ä¼¼nmapï¼‰
          - âœ… CVEæ¼æ´æ£€æµ‹
          - âœ… å¤šçº¿ç¨‹å¹¶å‘æ‰«æ
          - âœ… æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼ˆJSON/Text/CSVï¼‰
          - âœ… è‡ªåŠ¨æœåŠ¡è¯†åˆ«
          - âœ… ç‰ˆæœ¬å·æå–
          
          ## ğŸ› æŠ¥å‘Šé—®é¢˜
          å¦‚å‘ç°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æŠ¥å‘Šã€‚
          
          ---
          
          *ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼*
          
        draft: false
        prerelease: false
        files: |
          release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-homebrew:
    name: Publish to Homebrew (Optional)
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Display info
      run: |
        echo "ğŸ“¦ Homebrewå‘å¸ƒå‡†å¤‡"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ env.VERSION }}"
        
    # è¿™é‡Œå¯ä»¥æ·»åŠ Homebrew tapå‘å¸ƒçš„é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
    # é€šå¸¸éœ€è¦åˆ›å»ºformulaå¹¶æ¨é€åˆ°homebrew-tapä»“åº“